# Copyright 2025 NXP
# All rights reserved.
#
# SPDX-License-Identifier: BSD-3-Clause

import datetime
import os
import sys

SUCCESS      = 0
ERROR        = 1
OUT_FILENAME = "edgelock_firmware.h"
HEADER_GUARD = "__EDGELOCK_FIRMWARE_H__"
ARRAY_NAME   = "edgelock_fw"
HELPTEXT     = f"""
Script for converting a firmware binary to a C header file with an array
representation of the binary.

    Usage: python {sys.argv[0]} [-h|--help] FIRMWARE_BINARY_FILE

The output is placed (or overwritten) to an `{OUT_FILENAME}` file
in the same directory, in which this script was run.
The script takes one required argument; a path to the binary firmware file.

"""

def show_help():
    print(HELPTEXT, end='')

def main():

    if ("--help" in sys.argv) or ("-h" in sys.argv):
        show_help()
        return SUCCESS

    if (len(sys.argv) < 2):
        print("Error: binary filename is missing", file=sys.stderr)
        return ERROR

    # Strip filename from path
    image_filename_full = sys.argv[1]
    [_, image_filename] = os.path.split(image_filename_full)

    header_text = f'EdgeLock Firmware ({image_filename})'

    with open(image_filename_full, 'rb') as file:
        binary_data = file.read()

        # Split the data into bytes represented as strings
        # with 12 Bytes per string
        tmp_separator = ' '
        hex_str = binary_data.hex(tmp_separator, -12)
        split_str = hex_str.split(' ')

    # Construct the C array with correct formatting
    str_final = "\n"
    for s in split_str:
        l = len(s)
        tmp = ', 0x'.join(s[i:i+2] for i in range(0, l, 2))
        str_final += ('  0x' + tmp + ',\n')

    with open(OUT_FILENAME, 'w') as file:

        # Header
        file.write(f"""/**
 * Copyright {datetime.datetime.now().year} NXP
 * All rights reserved.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *
 *
 * This file was generated by a script.
 */

/*******************************************************************************
 *""")
        file.write(f' {header_text}')
        file.write(f"""
 ******************************************************************************/

#ifndef {HEADER_GUARD}
#define {HEADER_GUARD}

const uint8_t {ARRAY_NAME}[] = {{""")

        # The FW data
        file.write(str_final)

        # Footer
        file.write(f"""}};

#endif /* {HEADER_GUARD} */
""")

    return SUCCESS


if __name__ == "__main__":
    main()
